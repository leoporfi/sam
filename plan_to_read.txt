# Plan de Implementación: Gestión Dinámica de Configuración

Este plan detalla los pasos para migrar la configuración de negocio de variables de entorno a la base de datos y crear una interfaz de gestión.

# Objetivo
Permitir la modificación de parámetros de negocio (intervalos, timeouts, destinatarios de correo, etc.) en tiempo real desde la interfaz web, sin necesidad de acceso al servidor ni reinicio de servicios.

## User Review Required
> [!IMPORTANT]
> **Cambio de Schema de BD:** Se ampliará la columna `Valor` de la tabla `ConfiguracionSistema` a `NVARCHAR(MAX)` para soportar valores largos (ej. listas de emails, JSONs).
>
> **Precedencia:** La configuración en BD tendrá prioridad sobre el archivo `.env`. Si un valor existe en BD, se usará ese; si no, se usará el del `.env` como fallback.

## Proposed Changes

### Base de Datos

#### [MODIFY] [dbo_ConfiguracionSistema.sql](file:///c:/Users/lporfiri/RPA/sam/database/tables/dbo_ConfiguracionSistema.sql)
- Alterar columna `Valor` de `VARCHAR(255)` a `NVARCHAR(MAX)`.
- Asegurar que la tabla soporte la inserción de claves nuevas.

#### [NEW] [seed_config.sql](file:///c:/Users/lporfiri/RPA/sam/database/scripts/seed_config.sql)
- Script para poblar la tabla con las variables identificadas en el análisis (si no existen).
- Variables a migrar:
    - `EMAIL_RECIPIENTS`
    - `LANZADOR_INTERVALO_LANZAMIENTO_SEG`
    - `LANZADOR_INTERVALO_SINCRONIZACION_SEG`
    - `LANZADOR_INTERVALO_CONCILIACION_SEG`
    - `LANZADOR_MAX_WORKERS` (Opcional, aunque requiere reinicio, puede ser útil tenerlo en BD para visibilidad) -> *Decisión: Mantener en .env por requerir reinicio, o mover a BD con aviso de reinicio. Por ahora moveremos las que NO requieren reinicio prioritariamente.*
    - `LANZADOR_PAUSA_INICIO_HHMM`
    - `LANZADOR_PAUSA_FIN_HHMM`
    - `LANZADOR_HABILITAR_SYNC`
    - `BALANCEADOR_COOLING_PERIOD_SEG`
    - `BALANCEADOR_INTERVALO_CICLO_SEG`
    - `BALANCEADOR_POOL_AISLAMIENTO_ESTRICTO`
    - `INTERFAZ_WEB_SESSION_TIMEOUT_MIN`

### Backend (Python)

#### [MODIFY] [config_manager.py](file:///c:/Users/lporfiri/RPA/sam/src/sam/common/config_manager.py)
- Modificar `ConfigManager` para que tenga una instancia de conexión a BD (o use `DatabaseConnector` de forma estática/lazy).
- Implementar método `_get_config_value(key, default)`:
    1.  Buscar en caché local (TTL 60s).
    2.  Si no está, buscar en BD `ConfiguracionSistema`.
    3.  Si no está o error, buscar en `os.getenv`.
    4.  Retornar default.
- Actualizar los métodos `get_lanzador_config`, `get_balanceador_config`, etc., para usar este nuevo mecanismo en las variables migradas.

#### [MODIFY] [api.py](file:///c:/Users/lporfiri/RPA/sam/src/sam/web/backend/api.py)
- Crear nuevos endpoints:
    - `GET /api/config`: Listar todas las configuraciones editables.
    - `PUT /api/config/{key}`: Actualizar una configuración.
- Implementar validación básica de tipos (ej. si la clave termina en `_SEG`, validar que sea entero).

### Frontend (Web)

#### [NEW] [Configuracion.html](file:///c:/Users/lporfiri/RPA/sam/src/sam/web/frontend/Configuracion.html)
- Nueva página en el panel de administración.
- Tabla con: Clave, Valor Actual, Descripción, Botón Editar.
- Modal para editar valor.

#### [MODIFY] [sidebar.html](file:///c:/Users/lporfiri/RPA/sam/src/sam/web/frontend/components/sidebar.html)
- Agregar enlace a "Configuración".

## Verification Plan

### Automated Tests
- Crear test unitario para `ConfigManager` que verifique la precedencia (BD > Env > Default).
- Test de integración para el endpoint de actualización.

### Manual Verification
1.  **Seed:** Ejecutar script SQL y verificar datos en tabla.
2.  **Lectura:** Arrancar servicio y verificar que toma valores de BD (cambiar un valor en BD y ver si el servicio lo refleja tras reinicio o TTL).
3.  **Escritura:** Usar la nueva Web UI para cambiar `LANZADOR_INTERVALO_LANZAMIENTO_SEG`.
4.  **Validación:** Verificar en logs que el lanzador usa el nuevo intervalo.

# Análisis y Mejora de Variables de Entorno

Este documento detalla el análisis de las variables de entorno actuales del sistema SAM, su clasificación y una propuesta de mejora para optimizar su gestión, seguridad y facilidad de uso.

## 1. Resumen del Estado Actual

Actualmente, la configuración se carga principalmente desde archivos `.env` mediante `ConfigManager`. Existe una tabla `ConfiguracionSistema` en la base de datos, pero su uso es limitado (principalmente para umbrales de analítica).

**Problemas detectados:**
*   **Rigidez:** Cambiar reglas de negocio (ej. intervalos, límites) requiere editar archivos en el servidor y reiniciar servicios.
*   **Dispersión:** Alguna configuración está en código, otra en `.env`, y otra en BD.
*   **Seguridad:** Credenciales sensibles están en texto plano en `.env` (común, pero mejorable).

## 2. Clasificación y Propuesta de Migración

A continuación, se clasifican todas las variables identificadas.

### Leyenda
*   **INFRA (Infraestructura):** Datos necesarios para que la aplicación *arranque* (BD, Hosts, Puertos). **Deben quedarse en `.env`**.
*   **SECRETS (Secretos):** Contraseñas y Keys. **Deben quedarse en `.env`** (o Vault externo en futuro), nunca en BD sin encriptar.
*   **NEGOCIO (Lógica):** Parámetros que definen el comportamiento del negocio. **Candidatos a migrar a BD (`ConfiguracionSistema`)** para edición en tiempo real sin reinicio.

### Tabla de Variables

| Variable | Uso / Descripción | Tipo Actual | Propuesta | ¿Requiere Reinicio? |
| :--- | :--- | :--- | :--- | :--- |
| **LOGGING** | | | | |
| `LOG_DIRECTORY` | Ruta de logs | INFRA | **.env** | Sí |
| `LOG_LEVEL` | Nivel de detalle (INFO, DEBUG) | INFRA/NEGOCIO | **BD** (Ideal para debug en caliente) | No (si se migra) |
| `LOG_FORMAT`, `LOG_DATEFMT` | Formato de logs | INFRA | **.env** | Sí |
| **BASE DE DATOS (SAM & RPA360)** | | | | |
| `SQL_*_HOST`, `DB_NAME` | Conexión BD | INFRA | **.env** | Sí |
| `SQL_*_UID`, `PWD` | Credenciales BD | SECRETS | **.env** | Sí |
| `SQL_*_POOL_SIZE`, `TIMEOUT` | Tuning de conexión | INFRA | **.env** | Sí |
| **AUTOMATION ANYWHERE (AA)** | | | | |
| `AA_CR_URL` | URL Control Room | INFRA | **.env** | Sí |
| `AA_CR_USER`, `API_KEY` | Credenciales Bot Runner | SECRETS | **.env** | Sí |
| `AA_API_TIMEOUT_SECONDS` | Timeout llamadas API | INFRA | **.env** | Sí |
| `AA_TOKEN_REFRESH_BUFFER` | Buffer renovación token | INFRA | **.env** | Sí |
| **CALLBACK SERVER** | | | | |
| `CALLBACK_SERVER_HOST`, `PORT` | Binding del servidor | INFRA | **.env** | Sí |
| `CALLBACK_TOKEN` | Token de seguridad interno | SECRETS | **.env** | Sí |
| `CALLBACK_AUTH_MODE` | Modo auth | INFRA | **.env** | Sí |
| **EMAIL** | | | | |
| `EMAIL_SMTP_SERVER`, `PORT` | Servidor SMTP | INFRA | **.env** | Sí |
| `EMAIL_FROM`, `USER`, `PWD` | Credenciales SMTP | SECRETS | **.env** | Sí |
| `EMAIL_RECIPIENTS` | Destinatarios alertas | NEGOCIO | **BD** | No (si se migra) |
| **LANZADOR (Lógica de Negocio)** | | | | |
| `LANZADOR_INTERVALO_*` | Frecuencia de ciclos | NEGOCIO | **BD** | No (si se migra) |
| `LANZADOR_MAX_WORKERS` | Concurrencia | INFRA/NEGOCIO | **.env** (Afecta recursos SO) | Sí |
| `LANZADOR_MAX_REINTENTOS_*` | Lógica de reintentos | NEGOCIO | **BD** | No (si se migra) |
| `LANZADOR_PAUSA_*` | Ventana de mantenimiento | NEGOCIO | **BD** | No (si se migra) |
| `LANZADOR_HABILITAR_SYNC` | Feature Flag | NEGOCIO | **BD** | No (si se migra) |
| `CONCILIADOR_*` | Reglas de conciliación | NEGOCIO | **BD** | No (si se migra) |
| **BALANCEADOR** | | | | |
| `BALANCEADOR_COOLING_PERIOD` | Tiempo espera tras error | NEGOCIO | **BD** | No (si se migra) |
| `BALANCEADOR_INTERVALO_CICLO` | Frecuencia balanceo | NEGOCIO | **BD** | No (si se migra) |
| `BALANCEADOR_PROVEEDORES` | Feature Flag proveedores | NEGOCIO | **BD** | No (si se migra) |
| **INTERFAZ WEB** | | | | |
| `INTERFAZ_WEB_HOST`, `PORT` | Binding Web | INFRA | **.env** | Sí |
| `INTERFAZ_WEB_SESSION_TIMEOUT` | Timeout sesión | NEGOCIO | **BD** | No (si se migra) |
| `INTERFAZ_WEB_AA_*` | Credenciales AA Web | SECRETS | **.env** | Sí |
| **INTEGRACIONES (Clouders, APIGW)** | | | | |
| `CLOUDERS_API_URL` | Endpoint Clouders | INFRA | **.env** | Sí |
| `CLOUDERS_AUTH` | Token Clouders | SECRETS | **.env** | Sí |
| `API_GATEWAY_*` | Config Oauth/GW | INFRA/SECRETS | **.env** | Sí |

## 3. Plan de Acción

### Fase 1: Preparación de Base de Datos
1.  Asegurar que la tabla `ConfiguracionSistema` tenga los campos necesarios (actualmente tiene `Clave`, `Valor`, `Descripcion`, `FechaActualizacion`).
2.  Crear un script de migración ("seed") que inserte las variables de tipo **NEGOCIO** actuales del `.env` hacia la tabla `ConfiguracionSistema` con sus valores por defecto.

### Fase 2: Refactorización de Código (`ConfigManager`)
1.  Modificar `ConfigManager` para que, en las propiedades clasificadas como **NEGOCIO**, intente leer primero de la BD (usando un cache con TTL corto para no saturar la BD) y haga fallback al `.env` o valor default.
2.  Esto permite una transición suave: si no está en BD, sigue funcionando como antes.

### Fase 3: Gestión desde Interfaz Web
1.  Crear una nueva vista "Configuración del Sistema" en el frontend.
2.  Permitir editar los valores de la tabla `ConfiguracionSistema`.
3.  Implementar validación de tipos (enteros, booleanos, listas) en el backend antes de guardar.

## 4. Beneficios
*   **Agilidad:** El equipo de RPA puede ajustar intervalos de lanzamiento, destinatarios de correo o ventanas de pausa desde la Web sin pedir acceso al servidor ni reiniciar servicios.
*   **Seguridad:** Menos necesidad de acceso directo al servidor para cambios operativos.
*   **Auditoría:** Los cambios en configuración quedarán registrados (si agregamos auditoría a esa tabla).

## 5. Recomendaciones Adicionales
*   **Secretos:** Mantener las credenciales fuera de la BD. Si se requiere gestión web de credenciales en el futuro, usar un Vault o encriptación AES en BD.
*   **Documentación:** Mantener el `.env.example` solo con las variables de INFRA y SECRETS requeridas.
